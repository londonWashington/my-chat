<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ß–∞—Ç –∑ AI</title>
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
   <meta charset="UTF-8" />
  <title>AI Chat</title>
  <link id="favicon" rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí¨</text></svg>">

  <style>
    :root {
      --bg-color: #f9f9f9;
      --text-color: #333;
      --chat-bg: #fff;
      --user-bg: #e0f7fa;
      --ai-bg: #f5f5f5;
      --border-color: #ddd;
      --accent-color: #007bff;
    }
    body.dark {
      --bg-color: #18191c;
      --text-color: #eee;
      --chat-bg: var(--bg-color);
      --user-bg: #393b46;
      --ai-bg: var(--bg-color);
      --border-color: #444;
      --accent-color: #4da6ff;
    }
    html, body  {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      height: 100dvh;  
      margin: 0;
      padding: 0px;
      background: var(--bg-color);
      color: var(--text-color);
      transition: background 0.3s, color 0.3s;
      display: flex;
      flex-direction: column;
      overflow: hidden; /* –ó–∞–±–æ—Ä–æ–Ω—è—î–º–æ –ø—Ä–æ–∫—Ä—É—Ç–∫—É –≤—Å—ñ—î—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏ */
    }
    #chat-container {
        max-width: 1000px;
        margin: 0 auto;
        /* –í–∏–¥–∞–ª—ñ—Ç—å position: fixed */
        border: 0px solid var(--border-color);
        padding: 0px;
        background: var(--chat-bg);
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transition: all 0.3s;
        display: flex;
        flex-direction: column;
        height: 100dvh;  
        flex-grow: 1; /* –î–æ–∑–≤–æ–ª—è—î –∑–∞–π–º–∞—Ç–∏ –≤–µ—Å—å –≤—ñ–ª—å–Ω–∏–π –ø—Ä–æ—Å—Ç—ñ—Ä */
        min-height: 0; /* –í–∞–∂–ª–∏–≤–∏–π —Ä—è–¥–æ–∫, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ–≤ —É flexbox */
    }
    #chat-container.compact {
      max-width: 600px;
    }
    #chat-history {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
        border-bottom: 0px solid var(--border-color);
        margin-bottom: 0px;
        line-height: 1.7;  
        display: flex;
        flex-direction: column;       
        flex-shrink: 1; /* –î–æ–∑–≤–æ–ª—è—î–º–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É —Å—Ç–∏—Å–∫–∞—Ç–∏—Å—è */ 
    }
    .message {
      margin: 10px 0;
      padding: 10px;
      border-radius: 8px;
      max-width: 80%;
      min-width: 100px;
      word-wrap: break-word;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      position: relative;
    }
    .message.visible {
      opacity: 1;
      transform: translateY(0);
    }
    .user {
      background: var(--user-bg) !important;
      margin-left: auto;
      margin-right: 10px;
    }
    .ai {
      background: var(--ai-bg) !important;
      margin-right: auto;
      margin-left: 10px;
    }
    .copy-btn {
        position: absolute;
        top: 4px;
        right: 6px;
        font-size: 14px;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.2s;
    }
    .message:hover .copy-btn {
        opacity: 0.7;
    }
    .copy-btn:hover {
        opacity: 1;
    }
    #chat-container.compact #input-container {
      max-width: 600px; /* –î–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ–≥–æ —Ä–µ–∂–∏–º—É */
    }
    #chat-input {
      width: 100%;
      min-height: 90px;
      max-height: 50vh;
      overflow-y: auto;
      font-size: 18px;      /* –±—ñ–ª—å—à–∏–π —à—Ä–∏—Ñ—Ç */
      line-height: 1.5;     /* —â–æ–± —Ä—è–¥–∫–∏ –Ω–µ –∑–ª–∏–ø–∞–ª–∏—Å—è */
      padding: 2px;
      margin-top: 0px;
      border: 0px solid var(--bg-color);
      border-radius: 8px;
      background: var(--chat-bg);
      color: var(--text-color);
      resize: none;
      box-sizing: border-box;
    }
    #chat-input:focus {
        outline: none; /* –ü—Ä–∏–±–∏—Ä–∞—î–º–æ –±—ñ–ª–∏–π –±–æ—Ä–¥–µ—Ä –ø—Ä–∏ —Ñ–æ–∫—É—Å—ñ */
    }
    #send-btn::before {
        content: '‚û§'; /* –ó–Ω–∞—á–æ–∫ "–≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏" */
        font-size: 24px; /* –î–æ–¥–∞–Ω–æ: –ó–±—ñ–ª—å—à—É—î–º–æ —Ä–æ–∑–º—ñ—Ä —à—Ä–∏—Ñ—Ç—É –¥–ª—è –∑–Ω–∞—á–∫–∞ */
        line-height: 1;
    }
    #send-btn {
        content: '';
        background: var(--accent-color);
        color: white;
        border: none;
        border-radius: 50%; /* –†–æ–±–∏–º–æ –∫–Ω–æ–ø–∫—É –∫—Ä—É–≥–ª–æ—é */
        cursor: pointer;
        width: 50px;
        height: 50px;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: background 0.2s;
    } 
   #retry-btn::before {
        content: '‚Üª'; /* –°–∏–º–≤–æ–ª, —â–æ –æ–±–µ—Ä—Ç–∞—î—Ç—å—Å—è */
        font-size: 24px; /* –ó–±—ñ–ª—å—à—É—î–º–æ —Ä–æ–∑–º—ñ—Ä */
        line-height: 1; /* –°–∫–∏–¥–∞—î–º–æ –≤–∏—Å–æ—Ç—É —Ä—è–¥–∫–∞ */
        }
    #retry-btn {
        width: 50px; /* –ó–º–µ–Ω—à–µ–Ω–Ω—è —à–∏—Ä–∏–Ω–∏ */
        height: 50px; /* –ó–º–µ–Ω—à–µ–Ω–Ω—è –≤–∏—Å–æ—Ç–∏ */
        padding: 0;
        margin: 5px 2px 0 0;
        background: var(--accent-color);
        color: white;
        border: none;
        border-radius: 50%; /* –†–æ–±–∏–º–æ –∫–Ω–æ–ø–∫—É –∫—Ä—É–≥–ª–æ—é */
        cursor: pointer;
        transition: background 0.2s;
        font-size: 24px; /* –ó–±—ñ–ª—å—à—É—î–º–æ —Ä–æ–∑–º—ñ—Ä –∑–Ω–∞—á–∫–∞ */
        line-height: 50px;
        text-align: center;
    }
    #retry-btn { display: none; background: #ff9800; }    
    #send-btn:hover, #menu-toggle:hover {
      background: #0056b3;
    }
    #retry-btn:hover { background: #ae5802; }
    #menu-toggle {
      width: 10px;
      padding: 8px 12px;
      margin: 5px 2px 0 0;
      background: var(--accent-color);
      color: white;
      border: none;
      border-radius: 6px; 
      cursor: pointer;
      transition: background 0.2s;
    } 
    #menu-panel {
      display: none;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      margin-bottom: 10px;
      background: var(--chat-bg);
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    #menu-panel.visible {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }
    #url-input, #token-input, #search-input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      box-sizing: border-box;
    }
    #input-container {
        /* –í–∏–¥–∞–ª—ñ—Ç—å —Ü—ñ —Ä—è–¥–∫–∏ */
        /* position: fixed; */
        /* bottom: 20px; */
        /* left: 20px; */
        /* right: 20px; */
        /* max-width: 1000px; */
        /* margin: 0 auto; */
        display: flex;
        align-items: flex-end;
        gap: 10px;
        background: var(--chat-bg);
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
        z-index: 1000;
        /* –î–æ–¥–∞–π—Ç–µ —Ü–µ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è */
        border-top: 1px solid var(--border-color);
    }
    #loading {
      position: fixed;
      bottom: 70px; /* –ù–∞–¥ input-container */
      left: 50%;
      transform: translateX(-50%);
      color: var(--accent-color);
      font-style: italic;
      display: none;
    }
    /* –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å–∫—Ä–æ–ª–±–∞—Ä—É */
    ::-webkit-scrollbar {
        width: 8px; /* –†–æ–±–∏–º–æ —Å–∫—Ä–æ–ª–±–∞—Ä —Ç–æ–Ω—à–∏–º */
    }
    /* –ö–æ–ª—ñ—Ä —Ä—É—Ö–æ–º–æ—ó —á–∞—Å—Ç–∏–Ω–∏ (thumb) */
    ::-webkit-scrollbar-thumb {
        background-color: var(--border-color); /* –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –∫–æ–ª—ñ—Ä –±–æ—Ä–¥–µ—Ä–∞ */
        border-radius: 4px; /* –ó–∞–∫—Ä—É–≥–ª—é—î–º–æ –∫—Ä–∞—ó */
    }
    /* –ö–æ–ª—ñ—Ä —Ä—É—Ö–æ–º–æ—ó —á–∞—Å—Ç–∏–Ω–∏ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ –∫—É—Ä—Å–æ—Ä–∞ */
    ::-webkit-scrollbar-thumb:hover {
        background-color: var(--text-color);
    }
    /* –ö–æ–ª—ñ—Ä —Ç—Ä–µ–∫—É (—Ç–ª–∞ —Å–∫—Ä–æ–ª–±–∞—Ä—É) */
    ::-webkit-scrollbar-track {
        background-color: transparent;
    }
    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }

    .thinking-indicator {
        content: '';
        width: 24px; /* –†–æ–∑–º—ñ—Ä –∫–≤–∞–¥—Ä–∞—Ç–∞ */
        height: 24px;
        border: 4px solid var(--text-color);
        border-top: 4px solid var(--accent-color);
        border-radius: 50%; /* –†–æ–±–∏–º–æ –∫—Ä—É–≥ */
        animation: spin 1s linear infinite;
    }
    #send-btn.is-thinking::before {
        content: '';
        width: 24px;
        height: 24px;
        border: 4px solid var(--text-color);
        border-top: 4px solid var(--accent-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0;
    }
    #send-btn.is-thinking {
        pointer-events: none;
        cursor: default;
        background: transparent;
    }
  </style>
</head>
<body>
  <div id="chat-container">
    <button id="menu-toggle">‚ãÆ</button>
    <div id="menu-panel">
      <input type="text" id="url-input" placeholder="–í–≤–µ–¥—ñ—Ç—å URL –≤–µ–±—Ö—É–∫–∞ (–∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ)">
      <input type="text" id="token-input" placeholder="–í–≤–µ–¥—ñ—Ç—å —Ç–æ–∫–µ–Ω –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)">
      <input type="text" id="search-input" placeholder="–ü–æ—à—É–∫ –ø–æ —ñ—Å—Ç–æ—Ä—ñ—ó —á–∞—Ç—É...">
      <button id="clear-btn">–û—á–∏—Å—Ç–∏—Ç–∏ —á–∞—Ç</button>
      <button id="export-btn">–ï–∫—Å–ø–æ—Ä—Ç</button>
      <button id="theme-toggle">–¢–µ–º–Ω–∞ —Ç–µ–º–∞</button>
      <button id="compact-toggle">–ö–æ–º–ø–∞–∫—Ç–Ω–∏–π —Ä–µ–∂–∏–º</button>
    </div>
    <div id="chat-history"></div>
    <div id="input-container">
    <textarea id="chat-input" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..."></textarea>
        <div>
            <button id="send-btn"></button>
            <button id="retry-btn"></button>
        </div>
    </div>
    <div id="loading" class="loading">AI –¥—É–º–∞—î...</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/lib/marked.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    const chatHistory = document.getElementById('chat-history');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const retryBtn = document.getElementById('retry-btn');
    const clearBtn = document.getElementById('clear-btn');
    const exportBtn = document.getElementById('export-btn');
    const themeToggle = document.getElementById('theme-toggle');
    const compactToggle = document.getElementById('compact-toggle');
    const menuToggle = document.getElementById('menu-toggle');
    const menuPanel = document.getElementById('menu-panel');
    const urlInput = document.getElementById('url-input');
    const tokenInput = document.getElementById('token-input');
    const searchInput = document.getElementById('search-input');

    let lastMessage = '';
    let webhookUrl = localStorage.getItem('webhookUrl') || '';
    let authToken = localStorage.getItem('authToken') || '';
    let sessionId = localStorage.getItem('sessionId') || 'main-user';
    let messages = [];

    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
    urlInput.value = webhookUrl;
    tokenInput.value = authToken;
    if (localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark');
    if (localStorage.getItem('compactMode') === 'true') document.getElementById('chat-container').classList.add('compact');
    themeToggle.textContent = document.body.classList.contains('dark') ? '–°–≤—ñ—Ç–ª–∞ —Ç–µ–º–∞' : '–¢–µ–º–Ω–∞ —Ç–µ–º–∞';
    compactToggle.textContent = document.getElementById('chat-container').classList.contains('compact') ? '–ü–æ–≤–Ω–∏–π —Ä–µ–∂–∏–º' : '–ö–æ–º–ø–∞–∫—Ç–Ω–∏–π —Ä–µ–∂–∏–º';

    // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó
async function loadHistory() {
  if (!webhookUrl) {
    console.error('Webhook URL –Ω–µ –≤–∫–∞–∑–∞–Ω–æ');
    Swal.fire({ icon: 'error', title: '–ü–æ–º–∏–ª–∫–∞', text: '–í–∫–∞–∂—ñ—Ç—å URL –≤–µ–±—Ö—É–∫–∞', confirmButtonText: 'OK' });
    return;
  }
  const baseUrl = webhookUrl.split('/webhook/')[0];
  const historyUrl = `${baseUrl}/webhook/get-history?session_id=main-user`;
  try {
    const response = await fetch(historyUrl, { 
      method: 'GET', // –Ø–≤–Ω–æ –≤–∫–∞–∑—É—î–º–æ GET –¥–ª—è —ñ—Å—Ç–æ—Ä—ñ—ó
      headers: {
        'ngrok-skip-browser-warning': 'true' // –û–±—Ö—ñ–¥ ngrok interstitial
      },
      signal: AbortSignal.timeout(10000) // 10 —Å–µ–∫—É–Ω–¥, –Ω–µ 1 –º–ª–Ω
    });
    console.log('Response status:', response.status); // –î–µ–±–∞–≥
    console.log('Response headers:', [...response.headers.entries()]); // –î–µ–±–∞–≥ CORS
    if (!response.ok) {
      throw new Error(`HTTP error! Status: ${response.status}`);
    }
    const data = await response.json();
    console.log('History data:', data); // –î–µ–±–∞–≥
    if (data.history) {
      chatHistory.innerHTML = ''; // –û—á–∏—â–∞—î–º–æ, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –¥—É–±–ª—é–≤–∞–Ω–Ω—è
      messages = []; // –û—á–∏—â–∞—î–º–æ –º–∞—Å–∏–≤
      data.history.forEach(msg => {
        addMessage(msg.text, msg.isUser); 
      });
    }
    setTimeout(() => {
      chatHistory.scrollTop = chatHistory.scrollHeight;
    }, 100);
  } catch (error) {
    console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó:', error);
    Swal.fire({ icon: 'error', title: '–ü–æ–º–∏–ª–∫–∞', text: `–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é: ${error.message}`, confirmButtonText: 'OK' });
  }
}
document.addEventListener('DOMContentLoaded', loadHistory);

    // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å
    urlInput.addEventListener('change', () => {
      webhookUrl = urlInput.value;
      localStorage.setItem('webhookUrl', webhookUrl);
      loadHistory();
    });
    tokenInput.addEventListener('change', () => {
      authToken = tokenInput.value;
      localStorage.setItem('authToken', authToken);
    });

    // –î–∏–Ω–∞–º—ñ—á–Ω–∞ –≤–∏—Å–æ—Ç–∞ textarea
    chatInput.addEventListener('input', () => {
      chatInput.style.height = 'auto';
      chatInput.style.height = `${Math.min(chatInput.scrollHeight, window.innerHeight * 0.5)}px`;
    });

    // –ú–µ–Ω—é
    menuToggle.addEventListener('click', () => {
      menuPanel.classList.toggle('visible');
    });

    // –î–æ–¥–∞–≤–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    function addMessage(text, isUser) {
        const message = document.createElement('div');
        message.classList.add('message', isUser ? 'user' : 'ai', 'visible');

        let cleanedText = text
            .replace(/```markdown\n?/, '')
            .replace(/\n?```$/, '')
            .replace(/\\n/g, '\n')
            .replace(/^```|```$/g, '')
            .trim();

        const content = document.createElement('div');
        content.classList.add('message-content');
        content.innerHTML = isUser ? cleanedText : marked.parse(cleanedText);

        const copyBtn = document.createElement('span');
        copyBtn.classList.add('copy-btn');
        copyBtn.textContent = "üìã";
        copyBtn.title = "–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏";

        copyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(cleanedText).then(() => {
            copyBtn.textContent = "‚úÖ";
            setTimeout(() => (copyBtn.textContent = "üìã"), 1500);
            });
        });

        message.appendChild(content);
        message.appendChild(copyBtn);

        chatHistory.appendChild(message);
        setTimeout(() => {
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }, 10);

        messages.push({ text: cleanedText, isUser });
    }


    // —Å—Ç–∞–Ω–∏ favicon
    let aiThinking = false;
    let aiReady = false;

    function setFaviconEmoji(emoji) {
        const canvas = document.createElement("canvas");
        canvas.width = 64;
        canvas.height = 64;
        const ctx = canvas.getContext("2d");
        ctx.font = "64px serif";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(emoji, 32, 32);

        const favicon = document.getElementById("favicon");
        favicon.href = canvas.toDataURL("image/png");
    }

    function onAIThinking() {
        aiThinking = true;
        aiReady = false;
        setFaviconEmoji("‚è≥");
    }

    function onAIResponse(success = true) {
        aiThinking = false;
        aiReady = true;
        setFaviconEmoji(success ? "‚úÖ" : "‚ùå");
    }

    function resetFavicon() {
        if (aiReady && !aiThinking) {
        aiReady = false;
        setFaviconEmoji("üí¨");
        }
    }
    // user interaction ‚Üí reset
    document.addEventListener("visibilitychange", () => {
        if (!document.hidden) resetFavicon();
    });
    document.addEventListener("click", resetFavicon);
    document.addEventListener("keydown", resetFavicon);

 
    // –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    async function sendMessage(message = chatInput.value.trim()) {
    if (!message || !webhookUrl) return;

    // –î–æ–¥–∞—î–º–æ –∫–ª–∞—Å, —â–æ–± –ø–æ–∫–∞–∑–∞—Ç–∏ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä —ñ –±–ª–æ–∫—É—î–º–æ –∫–Ω–æ–ø–∫—É
    sendBtn.classList.add('is-thinking');
    sendBtn.disabled = true;

    addMessage(message, true);
    chatInput.value = '';
    chatInput.style.height = 'auto';
    retryBtn.style.display = 'none';
    lastMessage = message;

    // —Å—Ç–∞—Ä—Ç ‚Üí ‚è≥
    onAIThinking();

    try {
        const headers = { 'Content-Type': 'application/json' };
        if (authToken) headers['Authorization'] = `Bearer ${authToken}`;
        const response = await fetch(webhookUrl, {
        method: 'POST',
        headers,
        body: JSON.stringify({ message, session_id: 'main-user' }),
        signal: AbortSignal.timeout(1000000)
        });
        if (!response.ok) {
        throw new Error(`HTTP error! Status: ${response.status}`);
        }
        const data = await response.json();
        console.log('Received data:', data);
        
        // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
        sendBtn.classList.remove('is-thinking');
        sendBtn.disabled = false;
        
        if (data.reply) {
        addMessage(data.reply, false);
        onAIResponse(true);
        } else {
        handleError('–ù–µ–º–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –≤—ñ–¥ —Å–µ—Ä–≤–µ—Ä–∞');
        }
        // ‚úÖ –ü—ñ—Å–ª—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ ‚Äî –≥–∞–ª–æ—á–∫–∞
        setFaviconEmoji("‚úÖ");
    } catch (error) {
        // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ –ø–æ–∫–∞–∑—É—î–º–æ –ø–æ–º–∏–ª–∫—É
        sendBtn.classList.remove('is-thinking');
        sendBtn.disabled = false;
        handleError(`–ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è: ${error.message}`);
        onAIResponse(false);
    }
    }

    // –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫
    function handleError(errorText) {
      addMessage(`‚ùå ${errorText}`, false);
      retryBtn.style.display = 'inline-block';
      Swal.fire({ icon: 'error', title: '–ü–æ–º–∏–ª–∫–∞', text: errorText, confirmButtonText: 'OK' });
    }

    // Retry
    retryBtn.addEventListener('click', () => sendMessage(lastMessage));

    // –ü–æ—à—É–∫
    searchInput.addEventListener('input', () => {
      const query = searchInput.value.toLowerCase();
      chatHistory.querySelectorAll('.message').forEach(msg => {
        msg.style.display = msg.textContent.toLowerCase().includes(query) ? 'block' : 'none';
      });
    });

    // –û—á–∏—â–µ–Ω–Ω—è
    clearBtn.addEventListener('click', () => {
      chatHistory.innerHTML = '';
      messages = [];
    });

    // –ï–∫—Å–ø–æ—Ä—Ç
    exportBtn.addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(messages, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `chat_${sessionId}.json`;
      a.click();
      URL.revokeObjectURL(url);
    });

    // –¢–µ–º–∏
    themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark');
      localStorage.setItem('darkMode', document.body.classList.contains('dark'));
      themeToggle.textContent = document.body.classList.contains('dark') ? '–°–≤—ñ—Ç–ª–∞ —Ç–µ–º–∞' : '–¢–µ–º–Ω–∞ —Ç–µ–º–∞';
    });

    // –ö–æ–º–ø–∞–∫—Ç–Ω–∏–π —Ä–µ–∂–∏–º
    compactToggle.addEventListener('click', () => {
      document.getElementById('chat-container').classList.toggle('compact');
      localStorage.setItem('compactMode', document.getElementById('chat-container').classList.contains('compact'));
      compactToggle.textContent = document.getElementById('chat-container').classList.contains('compact') ? '–ü–æ–≤–Ω–∏–π —Ä–µ–∂–∏–º' : '–ö–æ–º–ø–∞–∫—Ç–Ω–∏–π —Ä–µ–∂–∏–º';
    });

    // –ü–æ–¥—ñ—ó
    sendBtn.addEventListener('click', () => sendMessage());
    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    }); 

    // –î–æ–¥–∞–π—Ç–µ —Ü–µ–π –∫–æ–¥ –≤ –≤–∞—à <script> –±–ª–æ–∫
    function setDynamicHeight() {
        const viewportHeight = window.innerHeight;
        const chatContainer = document.getElementById('chat-container');
        chatContainer.style.height = `${viewportHeight}px`;
    }

    // –í–∏–∫–ª–∏–∫–∞—î–º–æ —Ñ—É–Ω–∫—Ü—ñ—é –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Ç–∞ –∑–º—ñ–Ω—ñ —Ä–æ–∑–º—ñ—Ä—É –≤—ñ–∫–Ω–∞
    window.addEventListener('resize', setDynamicHeight);
    window.addEventListener('load', setDynamicHeight);
    
    // –ü–µ—Ä—à–∏–π –≤–∏–∫–ª–∏–∫
    setDynamicHeight();
  </script>
</body>
</html>
